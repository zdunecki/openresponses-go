name: Sync from OpenAI

on:
  schedule:
    # Run every 24 hours at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Specific tag to sync (leave empty for latest)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          go install github.com/loov/goda@latest
          go install github.com/zdunecki/gopkgcp@latest

      - name: Get latest upstream tag
        id: get-tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=$(gh api repos/openai/openai-go/tags --jq '.[0].name')
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Latest tag: ${TAG}"

      - name: Check if tag already exists
        id: check-tag
        run: |
          if git tag -l "${{ steps.get-tag.outputs.tag }}" | grep -q "^${{ steps.get-tag.outputs.tag }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.get-tag.outputs.tag }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.get-tag.outputs.tag }} does not exist, will sync"
          fi

      - name: Clean directory
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          # Remove all files except preserved ones
          shopt -s dotglob
          for item in *; do
            case "$item" in
              license|script.sh|.github|.goreleaser.yaml|.git)
                echo "Preserving: $item"
                ;;
              *)
                echo "Removing: $item"
                rm -rf "$item"
                ;;
            esac
          done

      - name: Clone upstream at tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          git clone --depth 1 --branch "${{ steps.get-tag.outputs.tag }}" \
            https://github.com/openai/openai-go.git /tmp/openai-go

      - name: Extract changelog for tag
        if: steps.check-tag.outputs.exists == 'false'
        id: changelog
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          # Extract changelog section for this tag from CHANGELOG.md
          # Format: ## X.Y.Z (date) ... until next ## or end
          CHANGELOG=$(awk -v tag="${TAG#v}" '
            /^## / {
              if (found) exit
              if ($2 == tag) found=1
            }
            found { print }
          ' /tmp/openai-go/CHANGELOG.md)

          # Store in file to preserve newlines
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "Extracted changelog for ${TAG}"

      - name: Extract responses package
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          cd /tmp/openai-go
          gopkgcp -pkg ./responses -o /tmp/extracted -mod github.com/zdunecki/openresponses-go/v3/v3 -v
          cd $GITHUB_WORKSPACE
          cp -r /tmp/extracted/* .

      - name: Build and verify
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          go build ./...
          echo "Build successful!"

      - name: Create Pull Request
        if: steps.check-tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          BRANCH="sync/${TAG}"
          CHANGELOG=$(cat /tmp/changelog.txt)

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch and commit with changelog
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "$(cat <<EOF
          Sync with openai/openai-go ${TAG}

          ${CHANGELOG}
          EOF
          )"

          # Push branch
          git push origin "$BRANCH"

          # Create PR with changelog in body
          gh pr create \
            --title "Sync with openai/openai-go ${TAG}" \
            --body "$(cat <<EOF
          ## Summary

          Automated sync from [openai/openai-go](https://github.com/openai/openai-go) tag \`${TAG}\`.

          ## Changelog from upstream

          ${CHANGELOG}

          ## Verification
          - [x] Build passed

          ---
          *This PR was automatically generated by the sync workflow.*
          EOF
          )" \
            --base master \
            --head "$BRANCH"
